SNS("SNS.util.Ajax",function(g){var i=KISSY,h=SNS.sys.Helper;var e=/^(\w+:)?\/\/([^\/?#]+)/;var a="crossdomain.htm",j="J_Crossdomain";var l={};var c={};var k=function(n){var o,m=n.indexOf("?");if(m==-1){o=n}else{o=n.substring(0,m)}return o};var d=function(n){var o=k(n),m;if(c[o]){KISSY.log(o+" is buzy");m=true}else{m=false;c[o]=o}return m};var f=function(n){var o=k(n),m;if(c[o]){c[o]=null}};var b=function(m,n){if(d(m)){return}this._apply({method:"post",url:m},n);this.c=KISSY.merge(n,{url:m});this.c.method=this.c.method?this.c.method:"post"};b.prototype={send:function(m,n){this._apply(n,{url:m});if(!this.c.url){return this}if(!this.c.use){this.c.use=this._autoCheck(this.c.url)}switch(this.c.use){case"xhr":this._YUIRequest();break;case"iframe":this._iframeRequest();break;case"jsonp":this._JSONPRequest();break}return this},_autoCheck:function(q){var o="xhr",t,n=location,s,m,u,r;t=e.exec(q);if(t){if(t[1]!==n.protocol||t[2]!==n.host){o="jsonp";if(t[1]===n.protocol){s=t[2].split(".");m=n.host.split(".");u=s[s.length-2]+s[s.length-1];r=m[m.length-2]+m[m.length-1];if(u==r){o="iframe"}}}else{o="xhr"}}return o},_apply:function(){var n=arguments,m=n.length;this.c=this.c?this.c:{};for(var o=0;o<m;o++){for(var q in n[o]){if(n[o][q]){this.c[q]=n[o][q]}}}},_YUIRequest:function(){var m=this;var o={success:function(p){f(m.c.url);if(m.c.dataType=="json"){p=i.JSON.parse(p.responseText)}if(m.c.dataType=="html"){p=p.responseText}if(m.c.success){m.c.success(p,m.c)}},failure:function(p){f(m.c.url);if(m.c.dataType=="json"){p=i.JSON.parse(p.responseText)}if(m.c.dataType=="html"){p=p.responseText}if(m.c.failure){m.c.failure(p,m.c)}}};var n=i.param(this.c.data);KISSY.ajax({type:this.c.method,url:this.c.url,data:this.c.data,success:function(p,r,q){o.success(q)},error:function(p,r,q){o.failure(q)}})},_dataToString:function(n){var m="";for(var o in n){if(n[o]!=null){m+=o+"="+encodeURIComponent(n[o])+"&"}if(m.length>0){m=m.substring(0,m.length-1)}return m}},_iframeRequest:function(){b.setDomain();var m=this,n;var p=function(){i.log("ready send"+n);var s={success:function(t){i.log("request successs:"+m.c.url);f(m.c.url);if(m.c.dataType=="html"){t=t.responseText}if(m.c.dataType=="json"){t=i.JSON.parse(t.responseText)}if(m.c.success){m.c.success(t,m.c)}},failure:function(t){i.log("request failuree :"+m.c.url);f(m.c.url);if(m.c.dataType=="json"){t=i.JSON.parse(t.responseText)}if(m.c.failure){m.c.failure(t,m.c)}}};var r=i.param(m.c.data);if(n&&n.contentWindow&&n.contentWindow.YAHOO){n.contentWindow.YAHOO.util.Connect.asyncRequest(m.c.method,m.c.url,s,r)}};var o=e.exec(this.c.url);var q=o[0]+"/"+a;n=l[q];if(n&&n._loaded==true){p()}else{if(n&&n._loaded==false){if(n.attachEvent){n.attachEvent("onload",function(){n._loaded=true;p()})}else{n.addEventListener("load",function(){n._loaded=true;p()},false)}}else{n=i.DOM.create('<iframe class="crossdomain" frameborder="0" width="0" height="0"  ></iframe>');if(n.attachEvent){n.attachEvent("onload",function(){n._loaded=true;p()})}else{n.addEventListener("load",function(){n._loaded=true;p()},false)}n.src=q;n._loaded=false;i.DOM.append(n,document.body)}}},_JSONPRequest:function(){var n,r,m=this;var o=++SNS._JSONP.counter;SNS._JSONP["c"+o]=function(s){if(r){window.clearTimeout(r);r=null}m.c.success.call(m,s,m.c);if(n&&n.parentNode){n.parentNode.removeChild(n)}};var p=KISSY.param(this.c.data);KISSY.log("_JSONPRequest before"+this.c.url);var q=this._buildUrl(this.c.url,p+"&callback=SNS._JSONP.c"+o);KISSY.log("_JSONPRequest after"+q);n=document.createElement("script");document.body.insertBefore(n,document.body.firstChild);window.setTimeout(function(){n.setAttribute("type","text/javascript");n.src=q},1);r=this._timeOut(n,this.c.timeout);return n},_timeOut:function(m,n,q){var o=n?n:5000;var p=window.setTimeout(function(){if(m&&m.parentNode){m.parentNode.removeChild(m)}if(q){q()}},o);return p},_buildUrl:function(m,n){m+=m.indexOf("?")>0?"&":"?";return m+n}};if(!SNS._JSONP){SNS._JSONP={};SNS._JSONP.counter=0}b.setDomain=function(){var n=window.location.hostname.toString();var p=n.split(".");var m=p.length;if(m>2){try{document.domain=p[m-2]+"."+p[m-1]}catch(o){KISSY.log("set Domain error")}}i.log("setDomain:"+document.domain);return document.domain};g.Ajax=b;g.request=function(n,m){return new b(n,m).send()};g.jsonp=function(n,m){m.use="jsonp";return new b(n,m).send()};(function(){function m(q){if(q instanceof Function){q=q()}var r=function(){var s=(this.initialize)?this.initialize.apply(this,arguments):this;return s};m._build(r,q);var p=r.prototype.parent;p=p?p:Object;r.constructor=m;r.prototype.constructor=r;return r}m.mixin=function(r,p){if(r){for(var q in (p||{})){if(p[q]!=null){r[q]=p[q]}}return r}};m.mixinFun=function(r,p,q){var s=function(t){r(t);p(t)};return function(){s.apply(q,arguments)}};m.clone=function(s){var q;switch(typeof(s)){case"object":q={};for(var u in s){q[u]=m.clone(s[u])}break;case"array":q=[];for(var t=0,r=s.length;t<r;t++){q[t]=m.clone(s[t])}break;default:return s}return q};m._build=function(q,r,u){if(typeof(r)=="object"){for(var v in r){m._build(q,v,r[v])}return q}var t=m.inheritance[r];if(t){u=t.call(q,u);if(u==null){return q}}var s=q.prototype;switch(typeof(u)){case"object":s[r]=m.clone(u);break;case"function":u._name=r;s[r]=u;break;case"array":s[r]=m.clone(u);break;default:s[r]=u;break}};m.inheritance={extend:function(p){this.parent=p;var q=function(){};q.prototype=p.prototype;this.prototype=new q();this.prototype.parent=function(){this._sope=arguments.callee._owner;var r=this._sope.parent.prototype[arguments.callee.caller._name];if(!r){throw new Error('The method "'+method+'" has no parent.')}this._sope=arguments.callee._owner;return r.apply(this,arguments)};this.prototype.parent._owner=this},implement:function(p){var r=[];if(typeof(p)=="array"){r=p}else{r.push(p)}for(var q=0;q<r.length;q++){var s=r[q];if(typeof(s)=="function"){r[q]=new s()}m.mixin(this.prototype,r[q])}},statics:function(p){m.mixin(this,p)}};var n=new m({initialize:function(p){this.config={url:null,parms:{},success:function(){},failure:function(){},callBackContext:this,iframeProxy:SNS.sys.Helper.getApiURI("http://comment.jianghu.{serverHost}/proxy.htm")};m.mixin(this.config,p)},getParms:function(q){var r=this.config.parms;m.mixin(r,q);m.mixin(r,{ran:Math.random()});var s="";for(var t in r){if(r[t]!=null){s+=t+"="+encodeURIComponent(r[t])+"&"}}if(s.length>0){s=s.substring(0,s.length-1)}return s},buildUrl:function(p,q){p+=p.indexOf("?")>0?"&":"?";return p+q},json:function(t,s,r){var p=this;var v={success:function(y){try{var w=YAHOO.lang.JSON.parse(y.responseText)}catch(x){throw new Error("Invalid response data")}p.config.success.call(this.callBackContext,w);if(s){s.call(this.callBackContext,w)}},failure:function(w){p.config.failure.call(this,w);if(r){r.call(this.callBackContext,w)}}};var q=this.getParms(t);YAHOO.util.Connect.initHeader("Accept","application/json");YAHOO.util.Connect.initHeader("X-Request","JSON");var u=YAHOO.util.Connect.asyncRequest("POST",this.config.url,v,q);return u},jsonp:function(r,u){var q=null;var w=null;var s=SNS.sys._JSONP_counter;SNS.sys._JSONP_counter++;var p=this;SNS.sys._JSONP_request_map["request_"+s]=function(x){if(w){window.clearTimeout(w);w=null}if(q&&q.parentNode){q.parentNode.removeChild(q)}p.config.success.apply(p.config.callBackContext,arguments);if(u){u.apply(p.config.callBackContext,arguments)}};var t=this.getParms(r);var v=this.buildUrl(this.config.url,t+"&callback=SNS.sys._JSONP_request_map.request_"+s);q=document.createElement("script");document.body.insertBefore(q,document.body.firstChild);window.setTimeout(function(){q.setAttribute("type","text/javascript");q.src=v},1);w=this._timeOut(q);return q},iframeProxy:function(z,x){var s=null;var A=function(){var D=window.location.hostname.toString();var E=D.split(".");var p=E.length;if(p>2){return E[p-2]+"."+E[p-1]}return D};document.domain=A();var y=SNS.sys._IFRAME_PROXY_counter;SNS.sys._IFRAME_PROXY_counter++;var C=this;var v=document.getElementsByName("SNS.sys._IFRAME_PROXY")[0];if(!v){throw new Error(" Invalid iframe proxy")}var t=document.createElement("form");SNS.sys._IFRAME_PROXY_request_map["request_"+y]=function(p){if(s){window.clearTimeout(s);s=null}C.config.success.apply(C.config.callBackContext,arguments);if(x){x.apply(C.config.callBackContext,arguments)}if(t&&t.parentNode){t.parentNode.removeChild(t)}};var u=this.buildUrl(this.config.url,"callback=SNS.sys._IFRAME_PROXY_request_map.request_"+y);v.setAttribute("src",this.config.iframeProxy);t.setAttribute("method","POST");t.setAttribute("action",u);t.setAttribute("target","SNS.sys._IFRAME_PROXY");var r=YAHOO.lang.merge(this.config.parms,z||{});for(var q in r){if(r[q]!=null){var w=document.createElement("input");w.setAttribute("type","hidden");w.setAttribute("name",q);w.setAttribute("value",r[q]);t.appendChild(w)}}document.body.insertBefore(t,document.body.firstChild);if(v.YAHOO&&v.YAHOO.util.Connect){var B=v.YAHOO.util.Connect.asyncRequest("POST",this.config.url,x,r);return B}t.submit();if(t&&t.parentNode){t.parentNode.removeChild(t)}s=this._timeOut(t)},_timeOut:function(p,q,t){var r=q?q:5000;var s=window.setTimeout(function(){if(p&&p.parentNode){p.parentNode.removeChild(p)}if(t){t()}},r);return s}});SNS.sys._IFRAME_PROXY_counter=0;SNS.sys._IFRAME_PROXY_request_map={};SNS.sys._JSONP_counter=0;SNS.sys._JSONP_request_map={};var o=new m({registerDataSource:function(q,p,r){if(p.url){this.dataSource=this.dataSource?this.dataSource:{};SNS.sys.Class.mixin(p,{callBackContext:r});this.dataSource[q]=new n(p)}},getDataSource:function(p){this.dataSource=this.dataSource?this.dataSource:{};return this.dataSource[p]}});SNS.sys.BasicDataSource=n;SNS.sys.DataSourceManager=o})()},"SNS.util.Helper");
