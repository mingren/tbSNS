SNS("SNS.widget.FeedEditor",function(){var b=YAHOO,c=b.util.Dom,j=b.util.Event,f=SNS.sys.Helper,k="\u6709\u5565\u60f3\u8bf4\u7684...";var d=140;var l="JPG|GIF|PNG|JPEG|BMP";var a=f.getApiURI("http://t.{serverHost}/weibo/addWeiboResult.htm",true,true);var h=f.getApiURI("http://t.{serverHost}/proxy.htm",true,true);var e='<!--<div >\u4f60\u8fd8\u53ef\u4ee5\u8f93\u5165<em class="num">140</em>\u4e2a\u5b57</div>--><div class="wrap"><div class="sub-tips"><i></i><p>Ctrl+Enter\u53ef\u4ee5\u5feb\u901f\u53d1\u8868</p></div><div class="arr"></div><div   class="error-msg"><span class="arrow"></span><p class="error">\u540c\u6b65\u66f4\u65b0\u53ea\u663e\u793a32\u4e2a\u6587\u5b57\u5185\u5bb9</p></div><form class="form" action="'+a+'"  enctype="multipart/form-data" method="post" target="hidden_frame"> <div class="sns-nf"><div class="b"><textarea maxlength="140" resize="none" name="content" class="f-area" >\u6709\u5565\u60f3\u8bf4\u7684...</textarea></div></div><div class="act "> <span class="tog" style="display:none"> <span class="sns-icon icon-insert-face">\u8868\u60c5</span> <span  class="sns-icon icon-insert-img">\u56fe\u7247</span> <span class="upload"><input name="fileData" class="input-upload"  type="file"/></span> <span class="file" style="display:none">[<em class="file-name"></em> <a class="imgdel" href="#">\u5220\u9664</a>]</span> <span class="rsync" style="display:none"><input id="rsyncBox" name="rsyncBox" class="rsync-box" type="checkbox"><label for="rsyncBox">\u8bbe\u7f6e\u4e3a\u963f\u91cc\u65fa\u65fa\u7b7e\u540d</label></span> <span class="shownum"><em class="num">140</em>/140</span></span> <span class="skin-red"><input type="hidden" class="syncTag" name="syncTag" /><input type="hidden" name="event_submit_do_publish_weibo" value="anything"/><input type="hidden" name="action" value="weibo/weiboAction"/><input type="hidden" class="from-type" name="type" value="2"/><div class="hiddentoken" style="display:none"></div> <a class="submit" href="#" >\u53d1\u8868</a><div class="hidden" ></div> </span> </div> </form><iframe name="hidden_frame" class="hidden-frame"  style="display: none;" src="'+h+'"></iframe> </div>';var i=function(){var n=window.location.hostname.toString();var o=n.split(".");var m=o.length;if(m>2){return o[m-2]+"."+o[m-1]}return n};document.domain=i();var g=function(m){this.config={container:"J_FeedEditor"};this._config(m);this._init()};g.prototype={_config:function(m){this.config=YAHOO.lang.merge(this.config,m||{})},_init:function(){this.container=c.get(this.config.container);if(!this.container){return}this._inject(this.container);this.content=c.get(this.config.container);this._createCallback();this._attach();new SNS.widget.MicroSuggest({autoHeight:false,root:this.container,className:"f-area"})},_inject:function(o){var m=c.get(o);if(m){m.innerHTML=e}var n=c.getElementsByClassName("from-type","input",m)[0];n.value=this.config.type?this.config.type:2},_setToken:function(){var m=c.get("Jianghu_tb_token");if(m){this._get("hiddentoken","div").innerHTML=m.innerHTML}},_attach:function(){var x=this,m=c.getElementsByClassName("input-upload","input",this.container)[0],v=this._get("f-area","textarea");v._value=v.value;if(this.config.defaultText){v.value=this.config.defaultText}var r=this._get("submit","a");var u=this._get("sub-tips","div");var o=this._get("skin-red","span");j.on(this.content,"click",function(A){var y=this;var z=j.getTarget(A);switch(z.className){case"imgdel":j.preventDefault(A);var t=f.showConfirm("\u786e\u8ba4\u5220\u9664\u56fe\u7247\u5417?",function(){y._resetImage()});break}},this,true);j.on(o,"click",function(t){j.stopEvent(t);this.submitData()},this,true);f.addMaxLenSupport(this.content,140,"f-area",function(){x.showNum()});var n=null;j.on(v,"focus",function(t){if(this.value==this._value){this.value=""}x.open(this)},v,true);j.on(v,"blur",function(t){if(this.value==""){this.value=this._value}},v,true);j.on(v,"keydown",function(t){if(t.keyCode==9){return false}});j.on(v,"keyup",function(A){var y=j.getEvent(A);var t=j.getCharCode(A);if(t==13&&y.ctrlKey){x.submitData();return}var B=this.value;var z=c.getElementsByClassName("rsync-box","input")[0];if(B.length>d){this.value=B.substring(0,d)}var B=KISSY.trim(this.value);if(B.length>=d){return}else{if(B.length<d){}}if(B.length>=32){return}else{if(B.length<32){}}},v,true);j.on(m,"change",this._showUploadFileName,this,true);this._fillFace();var s=[".feededitor"],w,q,p;j.on(document.body,"click",function(y){var t=true;w=j.getTarget(y);for(p=0;p<s.length;p++){q=s[p];if(KISSY.DOM.test(w,q)||KISSY.DOM.parent(w,q)){t=false}}if(t){x.close(v)}},this)},clearTxt:function(){var m=this._get("f-area","textarea");if(m.value==k){m.value=""}},_showUploadFileName:function(){var s=this._get("f-area","textarea");var t=this,m=c.getElementsByClassName("input-upload","input",this.container)[0],o=this._get("file","span"),r=this._get("file-name","em");if(r){var u=m.value;if(u==""){return true}var p=u.lastIndexOf(".");if(p<0||l.indexOf(u.substring(p+1).toUpperCase())<0){o.style.display="none";t._resetImage();SNS.sys.Helper.showMessage("<div>\u4e0a\u4f20\u683c\u5f0f\u4e0d\u6b63\u786e,\u56fe\u7247\u8bf4\u5b83\u53ea\u652f\u6301jpg\u3001bmp\u3001png\u3001gif\u3001jpeg\u683c\u5f0f.</div>");return false}else{var n=m.value.lastIndexOf("\\")+1;var q=m.value;if(n>0){q=m.value.substring(n)}n=q.lastIndexOf(".")+1;if(n>0&&q.length>8){r.innerHTML="..."+q.substring(q.length-8)}else{r.innerHTML=q}r.style.display="";o.style.display="";t._hasUpload=true}t.clearTxt()}},_resetText:function(){this._get("f-area","textarea").value=k},_resetImage:function(){var m=c.getElementsByClassName("upload","span",this.container)[0];m.innerHTML='<input name="fileData" class="input-upload"  type="file"/>';var n=c.getElementsByClassName("input-upload","input",m)[0];this._get("file","span").style.display="none";j.on(n,"change",this._showUploadFileName,this,true);this._hasUpload=false},_resetRsync:function(){this._get("rsync-box","input").checked=false},_checkRsync:function(){var m=true;var o=this._get("f-area","textarea");var n=this._get("rsync-box","input");if(this._hasUpload||this._checkFace()||o.value.length>32){m=false}if(m==true&&n.disabled){n.disabled=false}else{if(m==false){n.disabled=true}}},_clearData:function(){this._resetText();this._resetImage();this._hideTips()},_get:function(q,n,o){if(!o){o=this.content}var p="_"+q+"_"+n;var m=this[p];if(!m){m=c.getElementsByClassName(q,n,o)[0];this[p]=m}return m},_fillFace:function(){var n=this,m=this._get("f-area","textarea"),o=this._get("icon-insert-face","span");f.fixCursorPosition(m);this.facePanel=SNS.widget.faceSelector.init({elTrigger:o,container:n.config.container,insertBefore:function(){if(m.value.length>=140){return false}n.clearTxt()},insertAfter:function(p){c.setAttribute(m,"data-lastcursor","");window.setTimeout(function(){n.showNum()},100)}})},showNum:function(){var o=this._get("num","em");var m=this._get("f-area","textarea");var p=m.value;var q=140-p.length;if(q<0){q=0}o.innerHTML=q},_checkFace:function(){var n=false;var m=SNS.widget.faceSelector.getAllFaces(),q=null;if(m.length>0){var o=[];for(var p=0;p<m.length;++p){o[o.length]="\\"+m[p].code.split("").join("\\")}q=new RegExp(o.join("|"),"g");var r=q.test(this._get("f-area","textarea").value);n=r}return n},_showTips:function(m){var n=this._get("error-msg","div");this._get("error","p").innerHTML=m;n.style.display="block"},_hideTips:function(){var m=this._get("error-msg","div");this._get("error","p").innerHTML="";m.style.display="none"},_createCallback:function(){var m=this;SNS.app._Microblog_callback=function(n){if(n.status=="1"){m._clearData();if(m.config.onSuccess){m.config.onSuccess(n)}}else{if(n.status=="2"){f.showMessage(n.msg)}else{if(n.status=="4"){KISSY.use("",function(o){o.getScript("http://assets.taobaocdn.com/p/sns/1.0/widget/auth/auth.css?t="+new Date().getTime(),function(){},"GBK");o.getScript("http://assets.taobaocdn.com/p/sns/1.0/widget/auth/auth.js?t="+new Date().getTime(),function(){o.use("auth",function(p){p.sns.auth()})},"GBK")});return}else{if(!f.checkAndShowLogin()){return}}}}}},submitData:function(){this._get("f-area","textarea").blur();var m=this;if(!f.checkAndShowLogin({autoCallback:true})){return}this.clearTxt();var p=KISSY.trim(this._get("f-area","textarea").value);var o=this._get("form","form");var n=c.getElementsByClassName("input-upload","input",this.container)[0].value;if((p==""||p==k)&&n==""){SNS.sys.Helper.showMessage("\u8bf7\u8f93\u5165\u70b9\u5185\u5bb9\u5457.");this.value=k;return false}else{if(KISSY.trim(p.trim).length>d){SNS.sys.Helper.showMessage("\u592a\u957f\u5566~\u53fd\u6b6a\u7684\u5185\u5bb9\u4e0d\u80fd\u8d85\u8fc7140\u4e2a\u5b57.");return false}}if(this._get("rsync-box","input").checked){this._get("syncTag","input").value="true"}else{this._get("syncTag","input").value="false"}this._setToken();this._get("form","form").submit();window.setTimeout(function(){m._get("num","em").innerHTML="140"},500)},open:function(m){m.style.height="42px";this._get("tog","span").style.display="";KISSY.DOM.addClass(this._get("wrap","div"),"open");this.facePanel.place()},close:function(m){if(m.value==m._value){m.style.height="27px";this._get("tog","span").style.display="none";KISSY.DOM.removeClass(this._get("wrap","div"),"open");this.facePanel.place()}},initTopic:function(){var n=this;var p=this._get("sns-icon icon-topic","span");var o='<div class="topiclist"><ul><li class="topic">#wef#</li><li class="topic">#wef#</li><li class="topic">#wef#</li></ul>';"</div>";var m=new SNS.sys.NearbyPanel(p,o,{width:"50px",height:"50px",offsetTop:"10px",offsetLeft:"10px"});j.on(m.content,"click",function(r){var q=j.getTarget(r);if(q.className=="topic"){n.clearTxt();n._get("f-area","textarea").value+=q.innerHTML}m.hide()});this.topicPanel=m}};SNS.widget.FeedEditor=g},"SNS.util.Helper,SNS.widget.FeedSuggest,SNS.widget.Face");
