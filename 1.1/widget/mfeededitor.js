SNS("SNS.widget.MFeedEditor",function(){var b=YAHOO,d=b.util.Dom,m=b.util.Event,g=SNS.sys.Helper,n="\u6709\u5565\u60f3\u8bf4\u7684...";if(d.get("J_SNSFeedEditorTxt")){n=d.get("J_SNSFeedEditorTxt").innerHTML}var e=140;var o="JPG|GIF|PNG|JPEG|BMP";var a=g.getApiURI("http://t.{serverHost}/weibo/addWeiboResult.htm",true,true);var j=g.getApiURI("http://t.{serverHost}/proxy.htm",true,true);var i='<div class="topiclist"><div class="wrap-border"><span class="arrow"></span><ul><li><a href="#" class="topic">#\u65b0\u54c1\u4e0a\u67b6#</a></li><li><a href="#" class="topic">#\u6298\u6263\u4fc3\u9500#</a></li><li><a href="#" class="topic">#\u79d2\u6740#</a></li><li><a href="#" class="topic">#\u5e97\u94fa\u62bd\u5956#</a></li><li><a href="#" class="topic">#\u8d8a\u8f6c\u8d8a\u5f00\u5fc3#</a></li><li><a href="#" class="topic">#\u6625\u5b63\u4fc3\u9500\u6d3b\u52a8#</a></li><li class="newone"><a href="#" class="topic">#\u63d2\u5165\u65b0\u8bdd\u9898#</a></li></ul></div></div>';var c='<div class="goodslink"><div class="wrap-border"><span class="arrow"></span><input class="link" placeholder="\u8981\u5206\u4eab\u7684\u5b9d\u8d1d\u94fe\u63a5" type="text" /><p class="act"><span class="onlyt">\u4ec5\u652f\u6301\u6dd8\u5b9d\u7f51\u7684\u5b9d\u8d1d\u94fe\u63a5</span><a href="#" class="confirm">\u786e\u5b9a</a></p></div>';"</div>";var f='<!--<div >\u4f60\u8fd8\u53ef\u4ee5\u8f93\u5165<em class="num">140</em>\u4e2a\u5b57</div>--><div class="wrap"><div class="sub-tips"><i></i><p>Ctrl+Enter\u53ef\u4ee5\u5feb\u901f\u53d1\u8868</p></div><div class="arr"></div><div   class="error-msg"><span class="arrow"></span><p class="error">\u540c\u6b65\u66f4\u65b0\u53ea\u663e\u793a32\u4e2a\u6587\u5b57\u5185\u5bb9</p></div><form class="form" action="'+a+'"  enctype="multipart/form-data" method="post" target="hidden_frame"> <div class="sns-nf"><div class="b"><textarea maxlength="140" name="content" class="f-area" resize="none">'+n+'</textarea></div></div><div class="act "> <span class="sns-icon icon-insert-face">\u8868\u60c5</span> <span  class="sns-icon icon-insert-img">\u56fe\u7247</span> <span  class="sns-icon icon-topic">\u8bdd\u9898</span> <span  class="sns-icon icon-goods">\u5e97\u94fa\u5b9d\u8d1d</span> <span class="upload"><input name="fileData" class="input-upload"  type="file"/></span> <span class="file" style="display:none">[<em class="file-name"></em> <a class="imgdel" href="#">\u5220\u9664</a>]</span> <span class="rsync" style="display:none"><input id="rsyncBox" name="rsyncBox" class="rsync-box" type="checkbox"><label for="rsyncBox">\u8bbe\u7f6e\u4e3a\u963f\u91cc\u65fa\u65fa\u7b7e\u540d</label></span> <span class="shownum"><em class="num">140</em></span> <span class="skin-red"><input type="hidden" class="syncTag" name="syncTag" /><input type="hidden" name="event_submit_do_publish_weibo" value="anything"/><input type="hidden" name="action" value="weibo/weiboAction"/><input type="hidden" class="from-type" name="type" value="2"/><input type="hidden"  name="isMS" value="true"/><div class="hiddentoken" style="display:none"></div> <a class="submit" href="#" >\u53d1 \u8868</a><div class="hidden" ></div> </span> </div> </form><iframe name="hidden_frame" class="hidden-frame"  style="display: none;" src="'+j+'"></iframe>'+i+c+" </div>";var l=function(){var q=window.location.hostname.toString();var r=q.split(".");var p=r.length;if(p>2){return r[p-2]+"."+r[p-1]}return q};document.domain=l();var k=0;var h=function(p){this.config={container:"J_FeedEditor"};this._config(p);this._init()};h.prototype={_config:function(p){this.config=YAHOO.lang.merge(this.config,p||{})},_init:function(){this.container=d.get(this.config.container);if(!this.container){return}this._inject(this.container);this.content=d.get(this.config.container);this._createCallback();this._attach();this.initTopic();this.addGoods()},_inject:function(r){var p=d.get(r);if(p){p.innerHTML=f}var q=d.getElementsByClassName("from-type","input",p)[0];q.value=this.config.type?this.config.type:2},_setToken:function(){var p=d.get("Jianghu_tb_token");if(p){this._get("hiddentoken","div").innerHTML=p.innerHTML}},_attach:function(){var A=this,p=d.getElementsByClassName("input-upload","input",this.container)[0],y=this._get("f-area","textarea");y._value=y.value;if(this.config.defaultText){y.value=this.config.defaultText}var v=this._get("submit","a");var x=this._get("sub-tips","div");var r=this._get("skin-red","span");m.on(this.content,"click",function(D){var B=this;var C=m.getTarget(D);switch(C.className){case"imgdel":m.preventDefault(D);var t=g.showConfirm("\u786e\u8ba4\u5220\u9664\u56fe\u7247\u5417?",function(){B._resetImage()});break}},this,true);m.on(r,"click",function(t){m.stopEvent(t);this.submitData()},this,true);g.addMaxLenSupport(this.content,140,"f-area",function(){A.showNum()});var q=null;m.on(y,"focus",function(t){if(this.value==this._value){this.value=""}A.open(this)},y,true);m.on(y,"blur",function(t){if(this.value==""){this.value=this._value}},y,true);m.on(y,"keydown",function(t){if(t.keyCode==9){return false}});m.on(y,"keyup",function(D){var B=m.getEvent(D);var t=m.getCharCode(D);if(t==13&&B.ctrlKey){A.submitData();return}var E=this.value;var C=d.getElementsByClassName("rsync-box","input")[0];if(E.length>e){this.value=E.substring(0,e)}var E=KISSY.trim(this.value);if(E.length>=e){return}else{if(E.length<e){}}if(E.length>=32){return}else{if(E.length<32){}}},y,true);m.on(p,"change",this._showUploadFileName,this,true);this._fillFace();var w=[".feededitor"],z,u,s;m.on(document.body,"click",function(B){var t=true;z=m.getTarget(B);for(s=0;s<w.length;s++){u=w[s];if(KISSY.DOM.test(z,u)||KISSY.DOM.parent(z,u)){t=false}}if(t){A.close(y)}},this)},clearTxt:function(){var p=this._get("f-area","textarea");if(p.value==n){p.value=""}},_showUploadFileName:function(){var v=this._get("f-area","textarea");var w=this,p=d.getElementsByClassName("input-upload","input",this.container)[0],r=this._get("file","span"),u=this._get("file-name","em");if(u){var x=p.value;if(x==""){return true}var s=x.lastIndexOf(".");if(s<0||o.indexOf(x.substring(s+1).toUpperCase())<0){r.style.display="none";w._resetImage();SNS.sys.Helper.showMessage("<div >\u4e0a\u4f20\u683c\u5f0f\u4e0d\u6b63\u786e,\u56fe\u7247\u8bf4\u5b83\u53ea\u652f\u6301jpg\u3001bmp\u3001png\u3001gif\u3001jpeg\u683c\u5f0f.</div>");return false}else{var q=p.value.lastIndexOf("\\")+1;var t=p.value;if(q>0){t=p.value.substring(q)}q=t.lastIndexOf(".")+1;if(q>0&&t.length>8){u.innerHTML="..."+t.substring(t.length-8)}else{u.innerHTML=t}u.style.display="";r.style.display="";w._hasUpload=true;k=1}w.clearTxt()}},_resetText:function(){this._get("f-area","textarea").value=n},_resetImage:function(){var p=d.getElementsByClassName("upload","span",this.container)[0];p.innerHTML='<input name="fileData" class="input-upload"  type="file"/>';var q=d.getElementsByClassName("input-upload","input",p)[0];this._get("file","span").style.display="none";m.on(q,"change",this._showUploadFileName,this,true);this._hasUpload=false},_clearShopGood:function(){this._get("input-upload","input").disabled=false;this._get("input-upload","input").style.display="";if(this._get("link","input")){this._get("link","input").value=""}this._get("file","span").style.display="none";var q=["title","type","linkurl","itempic","sign"];for(var p=0;p<q.length;p++){this.delParam(q[p])}},_resetRsync:function(){this._get("rsync-box","input").checked=false},_checkRsync:function(){var p=true;var r=this._get("f-area","textarea");var q=this._get("rsync-box","input");if(this._hasUpload||this._checkFace()||r.value.length>32){p=false}if(p==true&&q.disabled){q.disabled=false}else{if(p==false){q.disabled=true}}},_clearData:function(){this._resetText();this._resetImage();this._hideTips();this._get("input-upload","input").setAttribute("disabled",false);this._get("input-upload","input").style.display="";k=0;this._clearShopGood()},_get:function(t,q,r){if(!r){r=this.content}var s="_"+t+"_"+q;var p=this[s];if(!p){p=d.getElementsByClassName(t,q,r)[0];this[s]=p}return p},_fillFace:function(){var q=this,p=this._get("f-area","textarea"),r=this._get("icon-insert-face","span");g.fixCursorPosition(p);this.facePanel=SNS.widget.faceSelector.init({elTrigger:r,container:q.config.container,insertBefore:function(){if(p.value.length>=140){return false}q.clearTxt()},insertAfter:function(s){d.setAttribute(p,"data-lastcursor","");window.setTimeout(function(){q.showNum()},100)}})},showNum:function(){var q=this._get("num","em");var p=this._get("f-area","textarea");var r=p.value;var s=140-r.length;if(s<0){s=0}q.innerHTML=s},_checkFace:function(){var q=false;var p=SNS.widget.faceSelector.getAllFaces(),t=null;if(p.length>0){var r=[];for(var s=0;s<p.length;++s){r[r.length]="\\"+p[s].code.split("").join("\\")}t=new RegExp(r.join("|"),"g");var u=t.test(this._get("f-area","textarea").value);q=u}return q},_showTips:function(p){var q=this._get("error-msg","div");this._get("error","p").innerHTML=p;q.style.display="block"},_hideTips:function(){var p=this._get("error-msg","div");this._get("error","p").innerHTML="";p.style.display="none"},_createCallback:function(){var p=this;SNS.app._Microblog_callback=function(q){if(q.status==1){p._clearData();if(p.config.onSuccess){p.config.onSuccess(q)}}else{if(q.status==2){g.showMessage(q.msg)}else{if(q.status=="4"){KISSY.use("",function(r){r.getScript("http://assets.taobaocdn.com/p/sns/1.0/widget/auth/auth.css?t="+new Date().getTime(),function(){},"GBK");r.getScript("http://assets.taobaocdn.com/p/sns/1.0/widget/auth/auth.js?t="+new Date().getTime(),function(){r.use("auth",function(s){s.sns.auth()})},"GBK")});return}else{if(!g.checkAndShowLogin()){return}}}}}},submitData:function(){this._get("f-area","textarea").blur();var p=this;if(!g.checkAndShowLogin({autoCallback:true})){return}this.clearTxt();var s=KISSY.trim(this._get("f-area","textarea").value);var r=this._get("form","form");var q=d.getElementsByClassName("input-upload","input",this.container)[0].value;if((s==""||s==n)&&q==""){SNS.sys.Helper.showMessage("\u8bf7\u8f93\u5165\u70b9\u5185\u5bb9\u5457.");this.value=n;return false}else{if(KISSY.trim(s).length>e){SNS.sys.Helper.showMessage("\u592a\u957f\u5566~\u53fd\u6b6a\u7684\u5185\u5bb9\u4e0d\u80fd\u8d85\u8fc7140\u4e2a\u5b57.");return false}}if(this._get("rsync-box","input").checked){this._get("syncTag","input").value="true"}else{this._get("syncTag","input").value="false"}this._setToken();this._get("form","form").submit();window.setTimeout(function(){p._get("num","em").innerHTML="140"},500)},open:function(p){p.style.height="57px"},close:function(p){if(p.value==p._value){p.style.height="27px"}},initTopic:function(){var p=this;var r=this._get("sns-icon icon-topic","span");var q=p._get("topiclist","div");m.on(r,"click",function(s){m.stopEvent(s);q.style.display="block"});m.on(document,"click",function(t){var s=m.getTarget(t);if(s!=q&&!KISSY.DOM.contains(q,s)){q.style.display="none"}},this,this);m.on(q,"click",function(t){var s=m.getTarget(t);m.stopEvent(t);if(s.className=="topic"){p.clearTxt();p._get("f-area","textarea").value+=s.innerHTML}q.style.display="none"})},addParam:function(q,s){var r=this._get("form","form");var p=this._get("addparam-"+q,"input");if(!p){p=KISSY.DOM.create('<input type="hidden" class="addparam-'+q+'" name='+q+" />");p.value=s;r.appendChild(p)}else{p.value=s}},delParam:function(q){var p=this._get("addparam-"+q,"input");if(p){p.value=""}},addGoods:function(){var q=this;var r=q._get("goodslink","div");var p=this._get("sns-icon icon-goods","span");m.on(p,"click",function(s){if(k==1){return}m.stopEvent(s);r.style.display="block"});m.on(document,"click",function(t){var s=m.getTarget(t);if(s!=r&&!KISSY.DOM.contains(r,s)){r.style.display="none"}},this,this);m.on(r,"click",function(t){var s=m.getTarget(t);m.stopEvent(t);if(s.className=="confirm"){SNS.request(g.getApiURI("http://fx.{serverHost}/share/getElementByURL.htm"),{dataType:"json",data:{url:q._get("link","input").value},success:function(v){r.style.display="none";if(v.status=="1"){q._get("input-upload","input").setAttribute("disabled",true);q._get("input-upload","input").style.display="none";k=2;q._get("file-name","em").innerHTML=v.result.title.substring(0,10)+"...";q._get("file","span").style.display="";for(var w in v.result){var u=v.result[w];if(w=="props"){u=KISSY.JSON.stringify(v.result.props)}q.addParam(w,u)}}else{g.showMessage(v.msg)}}})}})}};SNS.widget.FeedEditor=h},"SNS.util.Helper,SNS.widget.FeedSuggest,SNS.widget.Face");
