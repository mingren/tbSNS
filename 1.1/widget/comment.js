SNS("SNS.widget.Comment",function(){var a=KISSY,e=a.DOM,c=a.Event,b=SNS.sys.Helper;var d=function(f){d.superclass.constructor.call(this,f)};d.ATTRS={param:{value:null},paramList:{value:null},paramReply:{value:{}},paramFwd:{value:{}},rootNode:{value:"#J_CmtWidget"},txt:{value:"\u6211\u4e5f\u63d2\u53e5\u8bdd..."},content:{value:"12345"},maxLength:{value:140},isAutoHeight:{value:true},isSynMB:{value:false},isSuggest:{value:false},isOpen:{value:false},isReply:{value:false},moreurl:{varlue:""},checkcode:{value:""},postCmtReturn:{value:function(){}},addCallback:{value:function(){}},delCallback:{value:function(){}},initCmtCallback:{value:function(){}}};d.DOMS={content:{selector:".f-txt",attr:"value",to:"content"},checkcode:{selector:".f-checkcode",attr:"value",to:"checkcode"},checkcodeContainer:{selector:".checkcode"},sycMB:{selector:".J_SycMB",attr:"checked",to:"isSynMB"},face:{selector:".face"},txt:{selector:".f-txt"},list:{selector:"ul.comment-list"},cmt:{parent:"li"},form:{selector:".new-r"},count:{selector:".J_LetterCount"}};d.EVENTS={click:{".J_PostComment":"postCmtEvent",".J_UnfoldMoreComment":"unfoldMoreComment",".J_FoldMoreComment":"foldMoreComment",".J_DelR":"delCmtEvent",".J_ReR":"replyCmtEvent",".J_CreateReply":"createReplyEvent",".page,.page-up,.page-down":"getCmtListEvent",".page-up":"getCmtListEvent",".page-down":"getCmtListEvent"},focus:{".f-txt":"requireCheckCode"},keyup:{".f-txt":"showLength"}};d.AOPS={before:{postCmtEvent:["checkLogin","DOMToAttrs","valid"],"*Event":"preventDefault",delCmt:"checkLogin"}};SNS.Base.extend(d,SNS.data.Comment,{destroy:function(){var f=this.get("rootNode");e.get(f).innerHTML="";c.remove(f)},stopEvent:function(){var f=this.get("rootNode");c.on(f,"click",function(g){g.halt()})},init:function(){var f=this;a.ready(function(){f.renderCmtBox()});return f},renderCmtBox:function(){var j="getCmtBox",i,g=this.get("rootNode"),f,h=this;i=function(l){if(!l){return}e.get(g).innerHTML=l.result.html;f=h.getDOM("txt");if(f){b.addMaxLenSupport(e.get(g),h.get("maxLength"),"f-txt");h.showLength(null,f);h.initFace();h.initCheckCode();h.setMoreUrl();h.initSuggest();SNS.sys.form.setPlaceHolder(f)}var k=h.get("initCmtCallback");k(l)};this.simpleLoadData(j,i,this.get("param"),this.get("paramList"))},requireCheckCode:function(){if(this.checkCode){if(!this.checkCode.isShow()){this.checkCode.require()}}},postCmtEvent:function(h,m){var k="postCmt",n=this,l,i,j=n.get("content"),f=this.get("checkcode"),g={};j=n.getDOM("txt").value;l=function(u){var q=u.status,t=u.result,p=u.msg;if(q=="0"){i=n.getDOM("list");n.forward();n.checkCode.hide();n.reset();var o=n.get("postCmtReturn")(g,u);if(o==false){return}i.innerHTML=u.result.html+i.innerHTML}else{if(q=="12"||q=="13"){b.showMessage(p);n.checkCode.show(u.result.checkCodeUrl)}else{if(q=="16"){KISSY.use("",function(r){r.getScript("http://assets.taobaocdn.com/p/sns/1.0/widget/auth/auth.css?t="+new Date().getTime(),function(){},"GBK");r.getScript("http://assets.taobaocdn.com/p/sns/1.0/widget/auth/auth.js?t="+new Date().getTime(),function(){r.use("auth",function(s){s.sns.auth()})},"GBK")});return}else{b.showMessage(p)}}}if(n.get("addCallback")){n.get("addCallback")(g,u)}if(window.commentAfterCallback){commentAfterCallback(g,u)}};g=a.merge(g,this.get("param"),this.get("paramReply"),e.attr(m,"data-param"));g.content=j;g.TPL_checkcode=f;if(this.get("isSynMB")){g.isForward=this.get("isSynMB")}this.loadData(k,l,g)},delCmtEvent:function(j){j.preventDefault();var m="delCmt",h=j.target,i,f,g=this,l,k={};l=function(n){e.remove(g.getDOM("cmt",h));if(g.get("delCallback")){g.get("delCallback")(k,n)}if(window.delCommentAfterCallback){delCommentAfterCallback(k,n)}};k=a.merge(k,this.get("param"));this.simpleLoadData(m,l,this.get("param"),h)},getCmtListEvent:function(j,g){j.preventDefault();var l="getCmtList",i,h,f=this,k;h=e.attr(g,"data-param");if(!h){return}k=function(n){f.getDOM("list").innerHTML=n.result.html;var m=f.getDOM("txt");if(m){m.focus()}};this.simpleLoadData(l,k,this.get("param"),this.get("paramList"),g)},getCmtList:function(){},showMoreComment:function(){},replyCmtEvent:function(g,f){this.set("paramReply",a.JSON.parse(e.attr(f,"data-param")));this.getDOM("txt").value=e.attr(f,"data-txt");this.getDOM("txt").focus()},setDefaultValue:function(f){this.getDOM("txt").value=f},createReplyEvent:function(k,h){k.preventDefault();var j=e.parent(h,"li"),i=e.get(".fd-reply",j),g=this,f;i.style.display="block";f=JSON.parse(e.attr(h,"data-cfg"));f.rootNode=i;a.mix(f,g.get("commentCallback"));f.postCmtReturn=function(q,n){var m=g.getDOM("list");var p=e.create("<ul>");p.innerHTML=n.result.html;var l=e.get("li",p);var o=e.get("li",m);b.showMessage("\u8bc4\u8bba\u6210\u529f");e.insertBefore(l,o);i.style.display="none";if(h._c){h._c.destroy()}return false};f.initCmtCallback=function(){h._c.setDefaultValue(e.attr(h,"data-txt"))};h._c=new SNS.widget.Comment(f);h._c.stopEvent();h._c.init();return h._c},focus:function(){var f=this.getDOM("txt");if(f){f.focus()}},forward:function(){var g=this,h;if(!this.get("isSynMB")){return}a.log(this.get("paramFwd"));h=a.mix(this.get("paramFwd"),{content:g.get("content")});var f={paramFwd:h};new SNS.widget.Forward(f).forward()},reset:function(){this.setDOM("content","");this.getDOM("txt").value="";this.getDOM("count").innerHTML=this.get("maxLength");var f=this.get("rootNode");var g=e.get(".J_SycMB",f);if(g){g.checked=false}this.set("paramReply",{})},initFace:function(){var i=this,h=e.get(this.get("rootNode"));var j=this.getDOM("face");var g=this.getDOM("txt");var f=this.get("maxLength");SNS.widget.faceSelector.init({elTrigger:j,container:h,insertBefore:function(){if(g.value.length>=f){return false}},insertAfter:function(){if(f-g.value.length<0){var k=0}i.showLength(null,g,k)}})},initCheckCode:function(){var h=this,g=e.get(h.get("rootNode")),f=h.getDOM("checkcodeContainer");this.checkCode=new SNS.widget.CheckCode({rootNode:f})},initSuggest:function(){var f=this;new SNS.widget.MicroSuggest({root:e.get(f.get("rootNode")),className:"f-txt",autoHeight:false})},showLength:function(h,f,i){var g=this.getDOM("count");i=i?i:this.get("maxLength")-f.value.length;if(g){g.innerHTML=i}},valid:function(g){var i=this.get("content"),f=e.attr(this.getDOM("txt"),"placeholder"),h=SNS.sys.Helper.showMessage;if(i===""||i===f){h("\u5185\u5bb9\u4e0d\u80fd\u4e3a\u7a7a\u6216\u8005\u5168\u662f\u7a7a\u683c.");g.halt()}},checkLogin:function(g){var f=function(){};if(!b.checkAndShowLogin({callback:f})){g.halt()}},preventDefault:function(f){if(f&&f.arguments&&f.arguments[0]){f.arguments[0].preventDefault()}},setMoreUrl:function(){var g=this.getDOM("list"),f=e.get(".more-comment",g);if(f){f.href=this.get("moreurl")}}});SNS.widget.Comment=d},"SNS.data.Comment,SNS.data.Forward,SNS.widget.CheckCode,SNS.widget.Face,SNS.widget.FeedSuggest");
