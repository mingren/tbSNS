SNS("SNS.widget.Face",function(e){var e=YAHOO.util,b=e.Dom,p=e.Event,g=e.Get,l=YAHOO.lang,n=document,h=SNS.sys.Helper,m={elTrigger:"J_viewMoreSmile",container:"J_newComment",apiFaces:"comment:/json/face_json.htm"},k={params:null},f=null,d=function(r,q){p.on(r,"click",function(t){var s=p.getTarget(t);if((s.tagName.toUpperCase()!=="A"&&(s=s.parentNode).tagName.toUpperCase()!=="A")||!s.getAttribute("data-code")){return}p.stopEvent(t);var u=q.params;u.popupHandle&&u.popupHandle.hide();u.callback&&u.callback({faceId:s.getAttribute("data-code"),faceTitle:s.getAttribute("title")||"",faceUrl:s.getElementsByTagName("IMG")[0].src})})},o=function(){var q=n.createElement("DIV");b.addClass(q,"sns-popup popup-translucent popup-faces");q.innerHTML='<div class="hd naked"><span class="horn">^</span></div><div class="bd clearfix">loading ...</div>';n.body.appendChild(q);d(q,k);o=function(){return q};return o.apply(this,arguments)},c=function(q){var s=function(t){var u=document.createElement("div");u.innerHTML=t.replace(/<\/?[^>]+>/gi,"");return u.childNodes[0]?u.childNodes[0].nodeValue:""};if(!q.getAttribute("face-loaded")){var r=b.getElementsByClassName("bd","DIV",q)[0];setTimeout(function(){a(function(y){var t=y.allfaces;f=y;var w=[],v=0,u=n.createDocumentFragment(),z,x;for(;v<t.length;++v){x=t[v];z=n.createElement("A");z.setAttribute("data-code",s(x.code));z.setAttribute("title",x.title);z.innerHTML=KISSY.substitute("<img src='{imgUrl}' alt='{title}' />",x);u.appendChild(z)}r.innerHTML="";r.appendChild(u)})},0);q.setAttribute("face-loaded",true)}},i=function(t,q){var s=null;if(t&&t.elTrigger){var r='<div class="sns-popup popup-translucent popup-faces"><div class="hd naked"><span class="horn">^</span></div><div class="bd clearfix">loading ...</div></div>';s=new SNS.sys.NearbyPanel(t.elTrigger,r,{height:"270px",offsetTop:"10px",offsetLeft:"-20px",zIndex:99999,onShow:function(){c(s.mainContent);t.popupHandle=s;k.params=t;var u=b.getElementsByClassName("horn","SPAN",s.mainContent)[0];b[this.config.align==="right"?"addClass":"removeClass"](u,"right")}});d(s.mainContent,k)}return s},a=function(q){if(f){q&&q(f)}else{j.loadFaces=function(r){f=r;q&&q(f)};g.script(h.buildURI(h.getApiURI(m.apiFaces),"callback=SNS.widget.faceSelector.loadFaces"),{charset:"gbk"})}},j={init:function(t){l.augmentObject(m,t,true);var s=b.get(m.container),r=s.getElementsByTagName("textarea")[0];h.fixCursorPosition(r);var q=true;return i({elTrigger:m.elTrigger,callback:function(u){if(r.value==r.getAttribute("placeholder")){r.value=""}if(t.insertBefore){q=t.insertBefore()}if(q!=false){h.recoverCursorPos(r);h.insertText(r,u.faceId)}if(t.insertAfter){t.insertAfter()}}})},getAllFaces:function(){if(f){return f.allfaces}return[]},showDialog:function(r){var q=b.get(r.elTrigger);if(!q.popupHandle){q.popupHandle=i(r,true)}q.popupHandle&&q.popupHandle.show()}};SNS.widget.faceSelector=j},"SNS.util.Popup");
